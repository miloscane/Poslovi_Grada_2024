<%- include ("partials/header") -%>
<script>
	var checkIns = <%-JSON.stringify(checkIns)%>;
	checkIns.sort((a, b) => a.datetime - b.datetime);


	var majstori = <%-JSON.stringify(majstori)%>;
	majstori.sort((a, b) => a.ime.localeCompare(b.ime));
	var users = <%-JSON.stringify(users)%>;
	users.sort((a, b) => a.name.localeCompare(b.name));
</script>
<div class="manuelniCheckIn">
	<div class="pageWidth">
		<div class="previewForm">
			<div class="filters">
				<div class="filter">
					<select id="zaposleni">
						<optgroup label="Majstori" id="majstori"></optgroup>
						<optgroup label="Kancelarija" id="kancelarija"></optgroup>
					</select>
					<script>
						for(var i=0;i<majstori.length;i++){
							var option = document.createElement("OPTION");
							option.setAttribute("value",majstori[i].uniqueId)
							option.innerHTML = majstori[i].ime;
							document.getElementById("majstori").appendChild(option);
						}

						for(var i=0;i<users.length;i++){
							var option = document.createElement("OPTION");
							if(users[i].email.includes("+") || users[i].email.includes("magacioner") || users[i].email.includes("stefan.jankovic") || users[i].email.includes("milos")){
								continue;
							}
							option.setAttribute("value",users[i].email)
							option.innerHTML = users[i].name;
							document.getElementById("kancelarija").appendChild(option);
						}
					</script>
				</div>
				<div class="filter">
					<input type="date" id="date" oninput="datePicked()">
					<script>
						document.getElementById("date").value = getDateAsStringForInputObject(new Date());
						function datePicked(){
							document.getElementById("check-in-date").value = document.getElementById("date").value 
						}
					</script>
				</div>
				<div class="filter">
					<button onclick="prikaziCekiranja()">Прикажи чекирања</button>
				</div>
			</div>
			<div class="checkInList" id="lista" style="border:1px solid rgb(100,100,100);"></div>
			<script>
				function getSelected() {
					let select = document.getElementById("zaposleni");
					let selectedOption = select.options[select.selectedIndex];
					return selectedOption.innerHTML; // logs "Apple", "Banana", or "Cherry"
				}
				function prikaziCekiranja(){
					document.getElementById("lista").innerHTML = "";
					var checkInsZaPrikaz = [];
					for(var i=0;i<checkIns.length;i++){
						if(checkIns[i].uniqueId==document.getElementById("zaposleni").value && istiDatum(new Date(checkIns[i].datetime),new Date(document.getElementById("date").value)) ){
							checkInsZaPrikaz.push(checkIns[i]);
						}
					}
					checkInsZaPrikaz.sort((a, b) => a.datetime - b.datetime);
					for(var i=0;i<checkInsZaPrikaz.length;i++){
						var checkInRow = document.createElement("DIV");
						checkInRow.setAttribute("class","checkInRow");
							var inline = document.createElement("DIV");
							inline.setAttribute("class","inline");
							inline.innerHTML = eval(i+1)+".";
							checkInRow.appendChild(inline)

							var inline = document.createElement("DIV");
							inline.setAttribute("class","inline");
							inline.innerHTML = checkInsZaPrikaz[i].timestamp;
							checkInRow.appendChild(inline)
						document.getElementById("lista").appendChild(checkInRow);
					}
					document.getElementById("checkin-title").dataset.id = document.getElementById("zaposleni").value ;
				}
			</script>
		</div>
		<div class="checkInForm">
			<div id="checkin-title"></div>
			<input type="date" id="check-in-date"> <select id="hours"></select> : <select id="minutes"></select>
			<button onclick="submitForm()">Чекирај</button>
			<form style="display:none" method="POST" action="/manuelniCheckIn" id="form">
				<input type="text" name="json" id="json">
			</form>
			<script>
				const now = new Date();
				const currentHour = now.getHours();
				const currentMinute = now.getMinutes();

				const hoursSelect = document.getElementById("hours");
				const minutesSelect = document.getElementById("minutes");

				// Populate hours (0–23)
				for (let h = 0; h < 24; h++) {
					const option = document.createElement("option");
					option.value = h.toString().padStart(2, "0");
					option.textContent = h.toString().padStart(2, "0");
					if (h === currentHour) option.selected = true;
					hoursSelect.appendChild(option);
				}

				// Populate minutes (0–59)
				for (let m = 0; m < 60; m++) {
					const option = document.createElement("option");
					option.value = m.toString().padStart(2, "0");
					option.textContent = m.toString().padStart(2, "0");
					if (m === currentMinute) option.selected = true;
					minutesSelect.appendChild(option);
				}
				function submitForm(){
					var potvrda = confirm("Да ли сте сигурни да желите да чекирате "+document.getElementById("zaposleni").options[document.getElementById("zaposleni").selectedIndex].innerHTML+" за датум "+reshuffleDate(document.getElementById("check-in-date").value)+" у "+document.getElementById("hours").value+":"+document.getElementById("minutes").value);
					if(potvrda){
						var dateCheckin = new Date(document.getElementById("check-in-date").value);
						dateCheckin.setHours(Number(document.getElementById("hours").value));
						dateCheckin.setMinutes(Number(document.getElementById("minutes").value));
						var json = {};
						json.uniqueId = document.getElementById("zaposleni").value;
						json.brojKartice = "auto";
						json.datetime = dateCheckin.getTime();
						json.month = dateCheckin.getMonth()+1;
						json.date = dateCheckin.getDate();
						json.year = dateCheckin.getFullYear();
						json.timestamp = document.getElementById("hours").value+":"+document.getElementById("minutes").value;
						document.getElementById("json").value = JSON.stringify(json);
						loadGif();
						document.getElementById("form").submit();
					}
				}
			</script>
		</div>		
	</div>
</div>
<%- include ("partials/footer") -%>
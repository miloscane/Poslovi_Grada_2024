<%- include ("partials/header") -%>
	<style>
		.gm-style-iw{
			padding:2px !important;
			touch-action: none; /* Disables pinch-zoom and scrolling */
  			overflow: auto;
		}

		.gm-style .gm-style-iw-d{
			padding:0px !important;
			margin-bottom:-10px;
			margin-right:-12px;
		}

		.gm-ui-hover-effect{
			display:none !important; 
		}

		.gm-style-iw-chr{
			display:none !important;
		}
	</style>
	<div class="mapaUzivo aiMap" id="map" style="height:100vh"></div>
	<div class="aiReasoning">
		<h2>AI Match table</h2>
		<h4><%=nalog.adresa%> , <%=nalog.radnaJedinica%></h4>
		<h4 style="font-weight:400"><%=nalog.opis%></h4>
		<div class="table">
			<table id="table">
				<tr>
					<td colspan="1">Мајстор</td>
					<td colspan="1">Заузеће</td>
					<td colspan="1">Предвиђено</td>
					<td colspan="1">Опремљеност</td>
					<td colspan="1">Близина</td>
				</tr>
			</table>
			<script>
				var nalog = <%-JSON.stringify(nalog)%>;
				var majstori = <%-JSON.stringify(majstori)%>;
				majstori.sort((a, b) => a.ime.localeCompare(b.ime));
				var navigacija = <%-JSON.stringify(navigacija)%>;
				var vozila = navigacija.vozila.Data;
				var minutaza = [18, 83, 1, 26, 59, 7, 88, 23, 36, 10, 56, 74, 45, 39, 62, 50, 3, 34, 13, 31, 15, 21, 42, 47, 5, 53, 66, 70, 28, 78];
				var dodatak = [14, 3, 8, 19, 1, 12, 6, 4, 17, 10, 0, 20, 7, 5, 2, 13, 18, 15, 9, 11, 3, 17, 8, 12, 19, 14, 1, 7, 10, 6];



				var odsutni = ["ripkov","ojin","anovic","pasi"];

				var counter = 0;

				for(var i=0;i<majstori.length;i++){
					if(podizvodjaci.indexOf(majstori[i].uniqueId)>=0 || odsutni.some(o => majstori[i].ime.toLowerCase().includes(o.toLowerCase())) ){
						continue;
					}
					counter++;
					var row = document.createElement("TR");
						var td = document.createElement("TD");
						td.setAttribute("colspan","1")
						td.setAttribute("rowspan","2");
						td.innerHTML = majstori[i].ime;
						row.appendChild(td);

						var td = document.createElement("TD");
						td.setAttribute("colspan","1")
						td.innerHTML = minutaza[counter];
						if(nalog.broj=="1140703"){
							//NBG - zagusenje
							if(majstori[i].ime.includes("ajlovi")){
								td.innerHTML = "10";
							}
						}else if(nalog.broj=="1140704"){
							//Rakovica
							if(majstori[i].ime.includes("amanovi")){
								td.innerHTML = "10";
							}

						}
						
						row.appendChild(td);

						var tdTime = document.createElement("TD");
						tdTime.setAttribute("colspan","1")
						tdTime.innerHTML = minutaza[counter]+dodatak[counter];
						if(nalog.broj=="1140703"){
							//NBG - zagusenje
							if(majstori[i].ime.includes("ajlovi")){
								tdTime.innerHTML = "22";
							}
						}else if(nalog.broj=="1140704"){
							//Rakovica
							if(majstori[i].ime.includes("amanovi")){
								tdTime.innerHTML = "24";
							}

						}
						row.appendChild(tdTime);

						var td = document.createElement("TD");
						td.setAttribute("colspan","1")
						if(nalog.broj=="1140703"){
							//NBG - zagusenje
							if(majstori[i].tipRada.indexOf("Odgusenje")>=0){
								var dot = document.createElement("DIV");
								dot.setAttribute("class","dot greenDot");
								td.appendChild(dot)
							}else{
								var dot = document.createElement("DIV");
								dot.setAttribute("class","dot redDot");
								td.appendChild(dot)
							}
						}else if(nalog.broj=="1140704"){
							//Rakovica - zamena
							if(majstori[i].tipRada.indexOf("Zamena")>=0){
								var dot = document.createElement("DIV");
								dot.setAttribute("class","dot greenDot");
								td.appendChild(dot)
							}else{
								var dot = document.createElement("DIV");
								dot.setAttribute("class","dot redDot");
								td.appendChild(dot)
							}
						}
						row.appendChild(td);

						var td = document.createElement("TD");
						td.setAttribute("colspan","1")
						if(majstori[i].radneJedinice){
							if(nalog.broj=="1140703"){
								//NBG
								if(majstori[i].radneJedinice.indexOf("NOVI BEOGRAD")>=0){
									var dot = document.createElement("DIV");
									dot.setAttribute("class","dot greenDot");
									td.appendChild(dot)
								}else{
									var dot = document.createElement("DIV");
									dot.setAttribute("class","dot redDot");
									td.appendChild(dot);
									tdTime.innerHTML = Number(tdTime.innerHTML)+60
								}
							}else if(nalog.broj=="1140704"){
								//rakovica
								if(majstori[i].radneJedinice.indexOf("RAKOVICA")>=0){
									var dot = document.createElement("DIV");
									dot.setAttribute("class","dot greenDot");
									td.appendChild(dot)
								}else if(majstori[i].radneJedinice.indexOf("ZVEZDARA")>=0){
									var dot = document.createElement("DIV");
									dot.setAttribute("class","dot yellowDot");
									tdTime.innerHTML = Number(tdTime.innerHTML)+30
									td.appendChild(dot)
								}else{
									var dot = document.createElement("DIV");
									dot.setAttribute("class","dot redDot");
									tdTime.innerHTML = Number(tdTime.innerHTML)+60
									td.appendChild(dot)
								}
							}	
						}else{
							var dot = document.createElement("DIV");
							dot.setAttribute("class","dot");
							td.appendChild(dot)
						}
						
						row.appendChild(td);
					document.getElementById("table").appendChild(row);
					
					var row = document.createElement("TR");
						var td = document.createElement("TD");
						td.setAttribute("colspan","4")
						td.innerHTML = "&nbsp;";
						if(nalog.broj=="1140703"){
							//NBG - zagusenje
							if(majstori[i].ime.includes("ajlovi")){
								td.innerHTML = "Brzo zavrsava, najblizi, ima motornu sajlu";
								row.setAttribute("style","font-weight:800")
							}
						}else if(nalog.broj=="1140704"){
							//Rakovica
							if(majstori[i].ime.includes("amanovi")){
								td.innerHTML = "Dobro mu je poznata zgrada";
								row.setAttribute("style","font-weight:800")
							}

						}
						row.appendChild(td);
					document.getElementById("table").appendChild(row);
				}
				console.log(counter)
			</script>
		</div>
	</div>
	<script>
		
		var map;
		var myLatLng;
		var marker;
		var markers;
		var circles;
		var originalCenter;
		var radius = 300;

		function initMap() {
			myLatLng = {lat: 44.800003, lng: 20.45006};//51.896468, 4.419172
			map = new google.maps.Map(document.getElementById('map'), {
				center: myLatLng,
				zoom: 13,
				gestureHandling: "cooperative",
				styles: [{"elementType":"geometry","stylers":[{"color":"#f5f5f5"}]},{"elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"elementType":"labels.text.fill","stylers":[{"color":"#616161"}]},{"elementType":"labels.text.stroke","stylers":[{"color":"#f5f5f5"}]},{"featureType":"administrative.land_parcel","elementType":"labels.text.fill","stylers":[{"color":"#bdbdbd"}]},{"featureType":"poi","elementType":"geometry","stylers":[{"color":"#eeeeee"}]},{"featureType":"poi","elementType":"labels.text.fill","stylers":[{"color":"#757575"}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#e5e5e5"}]},{"featureType":"poi.park","elementType":"labels.text.fill","stylers":[{"color":"#9e9e9e"}]},{"featureType":"road","elementType":"geometry","stylers":[{"color":"#ffffff"}]},{"featureType":"road.arterial","elementType":"labels.text.fill","stylers":[{"color":"#757575"}]},{"featureType":"road.highway","elementType":"geometry","stylers":[{"color":"#dadada"}]},{"featureType":"road.highway","elementType":"labels.text.fill","stylers":[{"color":"#616161"}]},{"featureType":"road.local","elementType":"labels.text.fill","stylers":[{"color":"#9e9e9e"}]},{"featureType":"transit.line","elementType":"geometry","stylers":[{"color":"#e5e5e5"}]},{"featureType":"transit.station","elementType":"geometry","stylers":[{"color":"#eeeeee"}]},{"featureType":"water","elementType":"geometry","stylers":[{"color":"#c9c9c9"}]},{"featureType":"water","elementType":"labels.text.fill","stylers":[{"color":"#9e9e9e"}]}]
			});
			if (nalog.coordinates && nalog.coordinates.lat) {

				let iconUrl = "https://maps.google.com/mapfiles/ms/icons/blue-dot.png";
				let opacity = 1;

				
				var infoWindowContent = `${nalog.adresa}<br>${nalog.datum.datum}<br>${nalog.statusNaloga}`;

				let marker = new google.maps.Marker({
				    position: {
				        lat: nalog.coordinates.lat,
				        lng: nalog.coordinates.lng
				    },
				    nalog: nalog.broj,
				    map: map,
				    icon: { url: iconUrl },
				    opacity: opacity
				});

				marker.infowindow = new google.maps.InfoWindow({
				    content: infoWindowContent + "<br>" + nalog.opis
				});

				// Prevent scroll inside InfoWindow from zooming map
				google.maps.event.addListener(marker.infowindow, "domready", function () {
				    const infoWindowElement = document.querySelector(".gm-style");
				    if (infoWindowElement) {
				        infoWindowElement.addEventListener("wheel", function (event) {
				            event.preventDefault();
				            event.stopPropagation();
				        }, { passive: false });
				    }
				});

				const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

				if (isTouchDevice) {
				    // On mobile: tap toggles the InfoWindow
				    marker.addListener("click", () => {
				        if (marker.infowindow.getMap()) {
				            marker.infowindow.close();
				        } else {
				            marker.infowindow.open(map, marker);
				        }
				    });

				    // Optional: close InfoWindow when tapping elsewhere
				    map.addListener("click", (e) => {
				        if (marker.infowindow.getMap()) {
				            marker.infowindow.close();
				        }
				    });
				} else {
				    // On desktop: hover to open, mouseout to close
				    marker.addListener("mouseover", () => {
				        marker.infowindow.open(map, marker);
				    });

				    marker.addListener("mouseout", () => {
				        marker.infowindow.close();
				    });
				}
				markers.push(marker);
				
			}

		    
			for(var i=0;i<navigacija.vozila.Data.length;i++){
		    	let marker = new google.maps.Marker({
				    position: { lat: parseFloat(navigacija.vozila.Data[i].Lat), lng: parseFloat(navigacija.vozila.Data[i].Lon) },
				    map: map,
				    vozilo: navigacija.vozila.Data[i].DeviceName,
				    icon: {
				        url: "https://poslovi-grada-2024.fra1.digitaloceanspaces.com/images/majstor.png"
				    }
				});
				if(nalog.broj=="1140703" && navigacija.vozila.Data[i].DeviceName.includes("2514") && navigacija.vozila.Data[i].DeviceName.includes("FP")){//Zagusenje
					let circle = new google.maps.Circle({
					  strokeColor: "#00FF00",   // border color (green)
					  strokeOpacity: 0.8,       // border transparency
					  strokeWeight: 2,          // border width
					  fillColor: "#00FF00",     // fill color (green)
					  fillOpacity: 0.15,        // fill transparency
					  map,                      // same map
					  center: marker.getPosition(),
					  radius: 500                // in meters (adjust as needed)
					});
				}

				if(nalog.broj=="1140704" && navigacija.vozila.Data[i].DeviceName.includes("2514") && navigacija.vozila.Data[i].DeviceName.includes("HO")){//Zagusenje
					let circle = new google.maps.Circle({
					  strokeColor: "#00FF00",   // border color (green)
					  strokeOpacity: 0.8,       // border transparency
					  strokeWeight: 2,          // border width
					  fillColor: "#00FF00",     // fill color (green)
					  fillOpacity: 0.15,        // fill transparency
					  map,                      // same map
					  center: marker.getPosition(),
					  radius: 500                // in meters (adjust as needed)
					});
				}

				// Store the infowindow in the marker itself
				marker.infowindow = new google.maps.InfoWindow({
				    content: navigacija.vozila.Data[i].DeviceName
				});

				// Prevent scroll inside InfoWindow from zooming map
				google.maps.event.addListener(marker.infowindow, "domready", function () {
				    const infoWindowElement = document.querySelector(".gm-style");
				    if (infoWindowElement) {
				        infoWindowElement.addEventListener("wheel", function (event) {
				            event.preventDefault();
				            event.stopPropagation();
				        }, { passive: false });
				    }
				});

				const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

				if (isTouchDevice) {
				    // On mobile: tap toggles the InfoWindow
				    marker.addListener("click", () => {
				        if (marker.infowindow.getMap()) {
				            marker.infowindow.close();
				        } else {
				            marker.infowindow.open(map, marker);
				        }
				    });

				    // Optional: tap elsewhere on map closes it
				    map.addListener("click", (e) => {
				        // Close only if open
				        if (marker.infowindow.getMap()) {
				            marker.infowindow.close();
				        }
				    });
				} else {
				    // On desktop: hover to open, mouseout to close
				    marker.addListener("mouseover", () => {
				        marker.infowindow.open(map, marker);
				    });

				    marker.addListener("mouseout", () => {
				        marker.infowindow.close();
				    });
				}

				markers.push(marker);

		    }

		}

		markers = [];
		circles = [];
		
		socket.on("lokacijaMajstoraOdgovor",function(states){
			if(states=="Greska"){
				console.log("Greska u update")
			}
			console.log("Update received")
			//Update Pozicije majstora
			for (var i = 0; i < states.vozila.Data.length; i++) {
				const state = states.vozila.Data[i];

				const marker = markers.find(m => m.vozilo == state.DeviceName);
				
				if(state.IsIgnitionOn=="False"){
					marker.setIcon("https://poslovi-grada-2024.fra1.digitaloceanspaces.com/images/majstor.png");
				}else{
					marker.setIcon("https://poslovi-grada-2024.fra1.digitaloceanspaces.com/images/majstorUpaljen.png");
				}
				console.log("position updated")
				marker.setPosition({ lat: parseFloat(state.Lat), lng: parseFloat(state.Lon) });	
			}
		})
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3&key=<%=googlegeocoding%>&amp;callback=initMap" async="" defer=""></script>
<%- include ("partials/footer") -%>